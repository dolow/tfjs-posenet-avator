<!DOCTYPE html>
<html>
  <head>
    <style>
      #stage-image  { position: absolute; }
      #stage-canvas { position: absolute; }
      #stage-video  { position: absolute; }
      #camera       { transform: scaleX(-1); }
      #root         { display: none; }
    </style>
    <script type='text/javascript' src='./index.ts'></script>
    <script type='text/javascript'>
      const estimator = new PoseNetAvator();

      function initCamera() {
        const config = {
          audio: false,
          video: {
            width: 640,
            height: 640,
            facingMode: 'user' // front camera
            // facingMode: { exact: "environment" }  // rear camera
          }
        };
        return navigator.mediaDevices.getUserMedia(config).then((stream) => {
          const video = document.getElementById("camera");
          if (video.srcObject !== null) {
            return video;
          }
          video.width = config.video.width;
          video.height = config.video.height;
          video.srcObject = stream;
          return new Promise((resolve) => {
            video.addEventListener('loadedmetadata', (e) => {
              video.play();
              estimator.resize(config.video.width, config.video.height);
              resolve(video);
            });
          })
        });
      }

      function clear() {
        estimator.clear();
        const video = document.getElementById('camera');
        const image = document.getElementById('image-estimate');
        video.style.visibility = 'hidden';
        image.style.visibility = 'hidden';
      }

      function estimateWithVideo() {
        clear();

        const video = document.getElementById('camera');
        video.style.visibility = 'visible';
        initCamera().then((video) => estimator.estimate(video));
      }

      function estimateWithImage() {
        clear();

        const image = document.getElementById('image-estimate');
        image.style.visibility = 'visible';
        const url   = document.getElementById('text-url').value;
        image.src = url; // /resources/sample1.jpg
        image.addEventListener('load', () => {
          estimator.resize(image.width, image.height);
          estimator.estimate(image);
        });
        image.addEventListener('error', () => estimator.clear());
      }

      window.addEventListener('load', () => {
        const dom = document.getElementById('stage-canvas');
        estimator.init(dom).then(() => {
          const root    = document.getElementById('root');
          const loading = document.getElementById('loading');
          root.style.display    = 'block';
          loading.style.display = 'none';

          document.getElementById('button-url').addEventListener('click', () => estimateWithImage());
          document.getElementById('button-camera').addEventListener('click', () => estimateWithVideo());
        });
      });
    </script>
  </head>
  <body>
    <div id='loading'>
      Loading...
    </div>
    <div id='root'>
      <input id='text-url' type='text' />
      <input id='button-url' type='button' value='estimate with image' />
      <input id='button-camera' type='button' value='estimate with camera' />
      <div>
        <div id='stage-image'>
          <img id='image-estimate' />
        </div>
        <div id='stage-video'>
          <video id="camera"></video>
        </div>
        <div id='stage-canvas'></div>
      </div>
    </div>
  </body>
</html>
